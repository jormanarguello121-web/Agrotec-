<script src="../js/auth.js"></script>
<script src="../js/cliente.js"></script>
<script>
    let productos = [];

    document.addEventListener('DOMContentLoaded', function() {
        // Verificar autenticaci√≥n
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario || usuario.rol !== 'cliente') {
            window.location.href = '/login.html';
            return;
        }
        
        cargarProductosDisponibles();
    });

    async function cargarProductosDisponibles() {
        try {
            console.log('üîÑ Cargando productos...');
            
            // Intentar cargar desde la API
            const response = await fetch('/productos');
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('üì¶ Respuesta de la API:', data);
            
            // Diferentes estructuras posibles de la API
            if (data.productos && Array.isArray(data.productos)) {
                productos = data.productos;
            } else if (Array.isArray(data)) {
                productos = data;
            } else {
                console.warn('Estructura de datos inesperada:', data);
                productos = [];
            }
            
        } catch (error) {
            console.error('‚ùå Error cargando productos:', error);
            // Usar datos de ejemplo como fallback
            productos = obtenerProductosEjemplo();
        }
        
        console.log('üéØ Productos a mostrar:', productos);
        mostrarProductos();
    }

    function obtenerProductosEjemplo() {
        return [
            {
                id: 1,
                nombre: "üçÖ Tomates Org√°nicos",
                categoria: "verduras",
                precio: 2.5,
                cantidad: 50,
                descripcion: "Tomates frescos cultivados org√°nicamente sin pesticidas",
                agricultor: "Juan Agricultor",
                imagen: "",
                estado: "activo"
            },
            {
                id: 2,
                nombre: "ü•ë Aguacates Hass",
                categoria: "frutas", 
                precio: 4.0,
                cantidad: 0,
                descripcion: "Aguacates de primera calidad para exportaci√≥n",
                agricultor: "Pedro Productor",
                imagen: "",
                estado: "agotado"
            },
            {
                id: 3,
                nombre: "ü•ï Zanahorias Frescas",
                categoria: "verduras",
                precio: 1.8,
                cantidad: 30,
                descripcion: "Zanahorias dulces y crujientes reci√©n cosechadas",
                agricultor: "Mar√≠a Agricultora",
                imagen: "",
                estado: "activo"
            },
            {
                id: 4,
                nombre: "üçå Bananos Maduros",
                categoria: "frutas",
                precio: 1.2,
                cantidad: 25,
                descripcion: "Bananos naturales en su punto perfecto de maduraci√≥n",
                agricultor: "Carlos Campesino",
                imagen: "",
                estado: "activo"
            },
            {
                id: 5,
                nombre: "ü•¶ Br√≥coli Org√°nico",
                categoria: "verduras",
                precio: 3.5,
                cantidad: 15,
                descripcion: "Br√≥coli fresco cultivado de manera sostenible",
                agricultor: "Ana Agroecol√≥gica",
                imagen: "",
                estado: "activo"
            },
            {
                id: 6,
                nombre: "üçì Fresas de la Monta√±a",
                categoria: "frutas",
                precio: 5.0,
                cantidad: 8,
                descripcion: "Fresas rojas y jugosas cultivadas en altura",
                agricultor: "Roberto Fruticultor",
                imagen: "",
                estado: "activo"
            }
        ];
    }

    function mostrarProductos(productosFiltrados = null) {
        const lista = document.getElementById('listaProductos');
        const productosAMostrar = productosFiltrados || productos;
        
        console.log('üñ•Ô∏è Mostrando productos:', productosAMostrar);
        
        if (!productosAMostrar || productosAMostrar.length === 0) {
            lista.innerHTML = `
                <div class="no-products" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üì¶</div>
                    <h3>No hay productos disponibles</h3>
                    <p>No se encontraron productos en el marketplace</p>
                    <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 15px;">
                        üîÑ Recargar P√°gina
                    </button>
                </div>
            `;
            return;
        }
        
        lista.innerHTML = productosAMostrar.map(producto => `
            <div class="product-card" data-categoria="${producto.categoria}" data-precio="${producto.precio}">
                <div class="product-header">
                    <h4>${producto.nombre}</h4>
                    <span class="product-badge ${producto.cantidad > 0 ? 'disponible' : 'agotado'}">
                        ${producto.cantidad > 0 ? 'üü¢ Disponible' : 'üî¥ Agotado'}
                    </span>
                </div>
                
                <div class="product-details">
                    <div class="detail">
                        <strong>Categor√≠a:</strong> 
                        <span class="categoria" style="text-transform: capitalize;">${producto.categoria}</span>
                    </div>
                    <div class="detail">
                        <strong>Precio:</strong> 
                        <span class="precio" style="color: #28a745; font-weight: bold;">$${producto.precio}/kg</span>
                    </div>
                    <div class="detail">
                        <strong>Disponible:</strong> 
                        <span class="cantidad" style="font-weight: bold;">${producto.cantidad} kg</span>
                    </div>
                    <div class="detail">
                        <strong>Agricultor:</strong> 
                        <span class="agricultor" style="color: #666;">${producto.agricultor || 'Agricultor AgroTec'}</span>
                    </div>
                </div>
                
                ${producto.descripcion ? `
                    <div class="product-description">
                        <p style="margin: 0; color: #666; font-size: 0.95rem; line-height: 1.4;">${producto.descripcion}</p>
                    </div>
                ` : ''}
                
                <div class="product-actions">
                    <button class="btn btn-small" onclick="verDetallesProducto(${producto.id})" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer;">
                        üëÅÔ∏è Ver Detalles
                    </button>
                    <button class="btn btn-primary btn-small" 
                            onclick="agregarAlCarritoDesdeMarketplace(${producto.id})"
                            ${producto.cantidad === 0 ? 'disabled' : ''}
                            style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; ${producto.cantidad === 0 ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                        üõí Agregar al Carrito
                    </button>
                </div>
            </div>
        `).join('');
    }

    function agregarAlCarritoDesdeMarketplace(id) {
        const producto = productos.find(p => p.id === id);
        if (producto && producto.cantidad > 0) {
            // Usar el ClienteManager si est√° disponible
            if (window.clienteManager) {
                clienteManager.agregarAlCarrito(producto);
            } else {
                // Fallback: manejo local del carrito
                let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
                const itemExistente = carrito.find(item => item.id === id);
                
                if (itemExistente) {
                    itemExistente.cantidad += 1;
                } else {
                    carrito.push({
                        id: producto.id,
                        nombre: producto.nombre,
                        precio: producto.precio,
                        cantidad: 1,
                        agricultor: producto.agricultor
                    });
                }
                
                localStorage.setItem('carrito', JSON.stringify(carrito));
                
                // Mostrar mensaje
                alert(`‚úÖ ${producto.nombre} agregado al carrito`);
                
                // Actualizar contador
                actualizarContadorCarrito();
            }
        }
    }

    function actualizarContadorCarrito() {
        const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
        const cartCountElement = document.getElementById('cartCount');
        if (cartCountElement) {
            cartCountElement.textContent = totalItems;
        }
    }

    function filtrarProductos() {
        const busqueda = document.getElementById('buscarProducto').value.toLowerCase();
        const categoria = document.getElementById('filtroCategoria').value;
        const rangoPrecio = document.getElementById('filtroPrecio').value;
        
        let productosFiltrados = productos.filter(producto => {
            // Filtro por b√∫squeda
            const coincideBusqueda = producto.nombre.toLowerCase().includes(busqueda) ||
                                   (producto.descripcion && producto.descripcion.toLowerCase().includes(busqueda)) ||
                                   (producto.agricultor && producto.agricultor.toLowerCase().includes(busqueda));
            
            // Filtro por categor√≠a
            const coincideCategoria = categoria === 'todos' || producto.categoria === categoria;
            
            // Filtro por precio
            let coincidePrecio = true;
            if (rangoPrecio !== 'todos') {
                const [min, max] = rangoPrecio.split('-').map(val => val === '+' ? Infinity : parseFloat(val));
                coincidePrecio = producto.precio >= min && (max === Infinity || producto.precio <= max);
            }
            
            return coincideBusqueda && coincideCategoria && coincidePrecio;
        });
        
        mostrarProductos(productosFiltrados);
    }

    function verDetallesProducto(id) {
        const producto = productos.find(p => p.id === id);
        if (producto) {
            document.getElementById('modalContenido').innerHTML = `
                <h3 style="color: #333; margin-bottom: 20px;">${producto.nombre}</h3>
                <div class="product-details-modal" style="margin: 20px 0;">
                    <div class="detail-row" style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <strong>Categor√≠a:</strong> <span style="text-transform: capitalize;">${producto.categoria}</span>
                    </div>
                    <div class="detail-row" style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <strong>Precio:</strong> <span style="color: #28a745; font-weight: bold;">$${producto.precio}/kg</span>
                    </div>
                    <div class="detail-row" style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <strong>Disponible:</strong> <span style="font-weight: bold;">${producto.cantidad} kg</span>
                    </div>
                    <div class="detail-row" style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <strong>Agricultor:</strong> <span style="color: #666;">${producto.agricultor || 'Agricultor AgroTec'}</span>
                    </div>
                    ${producto.descripcion ? `
                    <div class="detail-row" style="margin-bottom: 15px;">
                        <strong>Descripci√≥n:</strong> 
                        <p style="margin: 10px 0 0 0; color: #666; line-height: 1.5;">${producto.descripcion}</p>
                    </div>
                    ` : ''}
                </div>
                <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-primary" 
                            onclick="agregarAlCarritoDesdeMarketplace(${producto.id}); cerrarModal()"
                            ${producto.cantidad === 0 ? 'disabled' : ''}
                            style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; ${producto.cantidad === 0 ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                        üõí Agregar al Carrito
                    </button>
                    <button class="btn btn-secondary" onclick="cerrarModal()" style="background: transparent; color: #667eea; border: 2px solid #667eea; padding: 10px 20px; border-radius: 20px; cursor: pointer;">
                        Cerrar
                    </button>
                </div>
            `;
            document.getElementById('modalProducto').style.display = 'block';
        }
    }

    function cerrarModal() {
        document.getElementById('modalProducto').style.display = 'none';
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('modalProducto');
        if (event.target === modal) {
            cerrarModal();
        }
    }

    // Inicializar contador de carrito
    document.addEventListener('DOMContentLoaded', function() {
        actualizarContadorCarrito();
    });
</script>
