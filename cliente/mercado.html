// === REEMPLAZA todo el script de mercado.html con esto ===

<script src="../js/auth.js"></script>
<script src="../js/cliente.js"></script>
<script>
    let productos = [];

    document.addEventListener('DOMContentLoaded', async function() {
        // Verificar autenticaci√≥n
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario || usuario.rol !== 'cliente') {
            window.location.href = '/login.html';
            return;
        }
        
        await cargarProductosDisponibles();
    });

    async function cargarProductosDisponibles() {
        try {
            // Usar el ClienteManager para cargar productos
            productos = await clienteManager.cargarProductosDisponibles();
            console.log('Productos cargados:', productos); // Para debug
            mostrarProductos();
        } catch (error) {
            console.error('Error cargando productos:', error);
            mostrarProductos(); // Mostrar productos vac√≠os o de ejemplo
        }
    }

    function mostrarProductos(productosFiltrados = null) {
        const lista = document.getElementById('listaProductos');
        const productosAMostrar = productosFiltrados || productos;
        
        if (!productosAMostrar || productosAMostrar.length === 0) {
            lista.innerHTML = `
                <div class="no-products">
                    <p>No hay productos disponibles en este momento</p>
                    <p>Intenta recargar la p√°gina o contactar al administrador</p>
                </div>
            `;
            return;
        }
        
        lista.innerHTML = productosAMostrar.map(producto => `
            <div class="product-card" data-categoria="${producto.categoria}" data-precio="${producto.precio}">
                <div class="product-header">
                    <h4>${producto.nombre}</h4>
                    <span class="product-badge ${producto.cantidad > 0 ? 'disponible' : 'agotado'}">
                        ${producto.cantidad > 0 ? 'üü¢ Disponible' : 'üî¥ Agotado'}
                    </span>
                </div>
                
                <div class="product-details">
                    <div class="detail">
                        <strong>Categor√≠a:</strong> 
                        <span class="categoria">${producto.categoria}</span>
                    </div>
                    <div class="detail">
                        <strong>Precio:</strong> 
                        <span class="precio">$${producto.precio}/kg</span>
                    </div>
                    <div class="detail">
                        <strong>Disponible:</strong> 
                        <span class="cantidad">${producto.cantidad} kg</span>
                    </div>
                    <div class="detail">
                        <strong>Agricultor:</strong> 
                        <span class="agricultor">${producto.agricultor || 'AgroTec'}</span>
                    </div>
                </div>
                
                ${producto.descripcion ? `
                    <div class="product-description">
                        <p>${producto.descripcion}</p>
                    </div>
                ` : ''}
                
                <div class="product-actions">
                    <button class="btn btn-small" onclick="verDetallesProducto(${producto.id})">
                        üëÅÔ∏è Ver Detalles
                    </button>
                    <button class="btn btn-primary btn-small" 
                            onclick="agregarAlCarrito(${producto.id})"
                            ${producto.cantidad === 0 ? 'disabled' : ''}>
                        üõí Agregar al Carrito
                    </button>
                </div>
            </div>
        `).join('');
    }

    function agregarAlCarrito(id) {
        const producto = productos.find(p => p.id === id);
        if (producto) {
            const agregado = clienteManager.agregarAlCarrito(producto);
            if (agregado) {
                // El mensaje ya se muestra en ClienteManager
            }
        }
    }

    function filtrarProductos() {
        const busqueda = document.getElementById('buscarProducto').value.toLowerCase();
        const categoria = document.getElementById('filtroCategoria').value;
        const rangoPrecio = document.getElementById('filtroPrecio').value;
        
        let productosFiltrados = productos.filter(producto => {
            // Filtro por b√∫squeda
            const coincideBusqueda = producto.nombre.toLowerCase().includes(busqueda) ||
                                   (producto.descripcion && producto.descripcion.toLowerCase().includes(busqueda)) ||
                                   (producto.agricultor && producto.agricultor.toLowerCase().includes(busqueda));
            
            // Filtro por categor√≠a
            const coincideCategoria = categoria === 'todos' || producto.categoria === categoria;
            
            // Filtro por precio
            let coincidePrecio = true;
            if (rangoPrecio !== 'todos') {
                const [min, max] = rangoPrecio.split('-').map(val => val === '+' ? Infinity : parseFloat(val));
                coincidePrecio = producto.precio >= min && (max === Infinity || producto.precio <= max);
            }
            
            return coincideBusqueda && coincideCategoria && coincidePrecio;
        });
        
        mostrarProductos(productosFiltrados);
    }

    function verDetallesProducto(id) {
        const producto = productos.find(p => p.id === id);
        if (producto) {
            document.getElementById('modalContenido').innerHTML = `
                <h3>${producto.nombre}</h3>
                <div class="product-details-modal">
                    <div class="detail-row">
                        <strong>Categor√≠a:</strong> ${producto.categoria}
                    </div>
                    <div class="detail-row">
                        <strong>Precio:</strong> $${producto.precio}/kg
                    </div>
                    <div class="detail-row">
                        <strong>Disponible:</strong> ${producto.cantidad} kg
                    </div>
                    <div class="detail-row">
                        <strong>Agricultor:</strong> ${producto.agricultor || 'AgroTec'}
                    </div>
                    ${producto.descripcion ? `
                    <div class="detail-row">
                        <strong>Descripci√≥n:</strong> 
                        <p>${producto.descripcion}</p>
                    </div>
                    ` : ''}
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" 
                            onclick="agregarAlCarrito(${producto.id}); cerrarModal()"
                            ${producto.cantidad === 0 ? 'disabled' : ''}>
                        üõí Agregar al Carrito
                    </button>
                    <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
                </div>
            `;
            document.getElementById('modalProducto').style.display = 'block';
        }
    }

    function cerrarModal() {
        document.getElementById('modalProducto').style.display = 'none';
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('modalProducto');
        if (event.target === modal) {
            cerrarModal();
        }
    }
</script>
